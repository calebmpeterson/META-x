<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello World!</title>
    <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline' 'unsafe-eval';"
    />
    <link
      rel="stylesheet"
      href="./node_modules/autocompleter/autocomplete.min.css"
    />
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <form id="command-form">
      <input
        id="command"
        type="text"
        autofocus
        placeholder="> transformation command"
        list="available-commands"
      />
    </form>

    <div class="selection-container">
      <div id="notification" class="toast">
        <div class="toast-message">Copied to clipboard</div>
      </div>
    </div>

    <textarea id="selection" readonly></textarea>

    <datalist id="available-commands"></datalist>

    <!-- Imports and utils -->
    <script>
      const fs = require("fs");
      const os = require("os");
      const path = require("path");
      const _ = require("lodash");
      const { clipboard } = require("electron");
      const autocomplete = require("autocompleter");
      const { getConfigDir } = require("./src/utils");

      const getCommands = () =>
        fs.readdirSync(getConfigDir()).filter((file) => file.endsWith(".js"));

      const getCommandFilename = (commandFilename) =>
        path.join(getConfigDir(), commandFilename);
    </script>

    <!-- UI interactions -->
    <script>
      const theCommandInput = document.getElementById("command");

      const selection = clipboard.readText("selection");
      const theSelectionTarget = document.getElementById("selection");
      theSelectionTarget.value = selection;

      const theCommandForm = document.getElementById("command-form");

      theCommandForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const commandFilename = getCommandFilename(theCommandInput.value);

        try {
          const commandModule = require(`${commandFilename}.js`);
          const result = commandModule.call(null, selection);
          console.log(`Result: ${result}`);

          const resultAsText =
            _.isArray(result) || _.isObject(result)
              ? JSON.stringify(result, null, "  ")
              : _.toString(result);

          clipboard.writeText(resultAsText);
          theSelectionTarget.value = resultAsText;
          theCommandInput.select();

          const theNotification = document.getElementById("notification");
          theNotification.classList.add("visible");
          setTimeout(() => theNotification.classList.remove("visible"), 2000);
        } catch (e) {
          console.error(`Failed to execute ${commandFilename}`, e);
        }
      });

      // Close on ESCAPE
      document.body.addEventListener("keyup", (e) => {
        if (e.keyCode === 27) {
          window.close();
        }
      });
    </script>

    <!-- Autocomplete functionality -->
    <script>
      const commands = getCommands();

      autocomplete({
        input: theCommandInput,
        className: "command-suggestions",
        render: (item, currentValue) => {
          const div = document.createElement("div");
          div.textContent = item.label;
          return div;
        },
        fetch: function (text, update) {
          const sanitized = text.toLowerCase();
          const matches = commands
            .filter((n) => n.toLowerCase().includes(sanitized))
            .map((command) => ({
              label: path.basename(command, ".js"),
              value: command,
            }));

          update(matches);
        },
        onSelect: function (item) {
          theCommandInput.value = item.label;
        },
      });
    </script>
  </body>
</html>
