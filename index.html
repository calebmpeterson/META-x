<!DOCTYPE html>
<html>
  <head>
    <meta charset="UTF-8" />
    <title>Hello World!</title>
    <!-- https://electronjs.org/docs/tutorial/security#csp-meta-tag -->
    <meta
      http-equiv="Content-Security-Policy"
      content="script-src 'self' 'unsafe-inline' 'unsafe-eval';"
    />
    <link
      rel="stylesheet"
      href="./node_modules/autocompleter/autocomplete.min.css"
    />
    <link rel="stylesheet" href="./index.css" />
  </head>
  <body>
    <form id="command-form">
      <input id="command" type="text" autofocus list="available-commands" />
    </form>

    <textarea id="selection" readonly></textarea>

    <datalist id="available-commands"></datalist>

    <script>
      const fs = require("fs");
      const os = require("os");
      const path = require("path");
      const { clipboard } = require("electron");
      const _ = require("lodash");

      const theCommandInput = document.getElementById("command");

      const selection = clipboard.readText("selection");
      const theSelectionTarget = document.getElementById("selection");
      theSelectionTarget.value = selection;

      const getCommands = () =>
        fs
          .readdirSync(path.join(os.homedir(), ".xselerate"))
          .filter((file) => file.endsWith(".js"));

      const getCommandFilename = (commandFilename) =>
        path.join(os.homedir(), ".xselerate", commandFilename);
    </script>

    <script>
      const theCommandForm = document.getElementById("command-form");

      theCommandForm.addEventListener("submit", (e) => {
        e.preventDefault();

        const commandFilename = getCommandFilename(theCommandInput.value);

        try {
          const commandModule = require(commandFilename);
          const result = commandModule.call(null, selection);
          console.log(`Result: ${result}`);

          const resultAsText =
            _.isArray(result) || _.isObject(result)
              ? JSON.stringify(result, null, "  ")
              : _.toString(result);

          clipboard.writeText(resultAsText);
          theSelectionTarget.value = resultAsText;
        } catch (e) {
          console.error(`Failed to execute ${commandFilename}`, e);
        }
      });
    </script>

    <script>
      const commands = getCommands();

      const commandToOption = (command) => {
        const option = document.createElement("option");
        option.innerText = command;
        option.value = command;
        return option;
      };

      const USE_NATIVE_AUTOCOMPLETE = false;
      const USE_TYPE_1_AUTOCOMPLETE = false;

      if (USE_NATIVE_AUTOCOMPLETE) {
        commands.map(commandToOption).forEach((option) => {
          document.getElementById("available-commands").appendChild(option);
        });
      } else {
        const autocomplete = require("autocompleter");

        autocomplete({
          input: theCommandInput,
          className: "command-suggestions",
          fetch: function (text, update) {
            const sanitized = text.toLowerCase();
            const matches = commands
              .filter((n) => n.toLowerCase().startsWith(sanitized))
              .map((command) => ({ label: command, value: command }));

            update(matches);
          },
          onSelect: function (item) {
            theCommandInput.value = item.value;
          },
        });
      }
    </script>
  </body>
</html>
